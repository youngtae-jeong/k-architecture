(function () {
  "use strict";

  // Static JSON generated by scripts/build-news-json.js
  const NEWS_JSON_URL = "/content/news.json";

  const listEl = document.getElementById("news-list");
  const emptyEl = document.getElementById("news-empty");

  let activeKey = null;
  let activeItemEl = null;

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return String(dateStr).slice(0, 10);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function renderMarkdownLite(text) {
    const safe = escapeHtml(text);
    return safe
      .split(/\n\n+/)
      .map((p) => `<p>${p.replace(/\n/g, "<br>")}</p>`)
      .join("");
  }

  function buildInlineDetail(item) {
    const title = escapeHtml(item.title || "");
    const date = escapeHtml(formatDate(item.date));
    const img = item.thumbnail
      ? `<img class="news-inline-image" src="${escapeHtml(item.thumbnail)}" alt="${title}">`
      : "";
    const body = renderMarkdownLite(item.body || item.summary || "");

    return `
      <div class="news-inline-split">
        <div class="news-inline-media">${img}</div>
        <div class="news-inline-content">
          <h3 class="news-inline-title">${title}</h3>
          ${date ? `<div class="news-inline-date">${date}</div>` : ""}
          <div class="news-inline-body">${body}</div>
        </div>
      </div>
    `;
  }

  function closeActive() {
    if (!activeItemEl) return;

    activeItemEl.classList.remove("is-open");
    const card = activeItemEl.querySelector(".news-card");
    if (card) card.classList.remove("active");

    const detail = activeItemEl.querySelector(".news-inline-detail");
    if (detail) {
      // Let the closing animation run, then clear content.
      const prevKey = activeKey;
      setTimeout(() => {
        // Only clear if still closed and still the same item (prevents race conditions)
        if (!activeItemEl || activeKey !== prevKey) return;
        detail.innerHTML = "";
      }, 260);
    }

    activeKey = null;
    activeItemEl = null;
  }

  function openItem(itemEl, item, key) {
    // Close existing
    if (activeItemEl && activeItemEl !== itemEl) {
      closeActive();
    }

    const detail = itemEl.querySelector(".news-inline-detail");
    const card = itemEl.querySelector(".news-card");
    if (!detail || !card) return;

    // Fill content before opening so it fades in smoothly.
    detail.innerHTML = buildInlineDetail(item);

    itemEl.classList.add("is-open");
    card.classList.add("active");

    activeKey = key;
    activeItemEl = itemEl;

    // Smoothly bring the opened item into view (nice on long lists)
    itemEl.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  function buildItem(item) {
    const title = escapeHtml(item.title || "");
    const date = escapeHtml(formatDate(item.date));
    const thumb = item.thumbnail
      ? `<img src="${escapeHtml(item.thumbnail)}" alt="${title}">`
      : "";
    const summary = escapeHtml(item.summary || "");

    const key = String(item.slug || item.title || "");

    const itemEl = document.createElement("div");
    itemEl.className = "news-item";

    itemEl.innerHTML = `
      <article class="news-card" tabindex="0" role="button" aria-expanded="false">
        <div class="news-card-thumb">${thumb}</div>
        <div class="news-card-meta">
          <h4 class="news-card-title">${title}</h4>
          ${date ? `<div class="news-card-date">${date}</div>` : ""}
          ${summary ? `<div class="news-card-summary">${summary}</div>` : ""}
        </div>
      </article>
      <div class="news-inline-detail" aria-live="polite"></div>
    `;

    const card = itemEl.querySelector(".news-card");

    function onActivate() {
      // Toggle: same item closes
      if (activeKey === key) {
        // Close
        itemEl.classList.remove("is-open");
        card.classList.remove("active");
        card.setAttribute("aria-expanded", "false");
        const detail = itemEl.querySelector(".news-inline-detail");
        // Clear after transition
        setTimeout(() => {
          if (!itemEl.classList.contains("is-open")) detail.innerHTML = "";
        }, 260);
        activeKey = null;
        activeItemEl = null;
        return;
      }

      card.setAttribute("aria-expanded", "true");
      openItem(itemEl, item, key);
    }

    card.addEventListener("click", (e) => {
      e.preventDefault();
      onActivate();
    });

    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        onActivate();
      }
    });

    return itemEl;
  }

  async function init() {
    if (!listEl || !emptyEl) return;

    try {
      const res = await fetch(NEWS_JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch news.json: ${res.status}`);
      const data = await res.json();
      const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);

      if (!items.length) {
        emptyEl.style.display = "block";
        return;
      }

      emptyEl.style.display = "none";
      listEl.innerHTML = "";
      items.forEach((item) => listEl.appendChild(buildItem(item)));

    } catch (err) {
      console.error(err);
      emptyEl.style.display = "block";
      emptyEl.textContent = "Failed to load news posts.";
    }
  }

  document.addEventListener("DOMContentLoaded", init);
})();
